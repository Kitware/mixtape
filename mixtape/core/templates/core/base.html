<!DOCTYPE html>
<html lang="en" x-data :data-theme="$store.theme.darkMode ? 'dark' : 'light'" class="bg-base-300">
  <head>
    {% load static ga4_study %}
    {% ga4_head %}
    <script defer src="{% static 'django_ga4_study/ga_core.js' %}"></script>
    <script defer src="{% static 'django_ga4_study/ga_visibility.js' %}"></script>
    <script defer src="{% static 'django_ga4_study/ga_minimals.js' %}"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="//unpkg.com/alpinejs" defer></script>
    <script src="//unpkg.com/plotly.js@3.0.1/dist/plotly.min.js" charset="utf-8"></script>
    <link href="https://unpkg.com/remixicon/fonts/remixicon.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <!-- Global Variables -->
    <script>
      document.addEventListener('alpine:init', () => {
        // Theme store
        Alpine.store('theme', {
          darkMode: window.matchMedia('(prefers-color-scheme: dark)').matches,
          darkbg: '#15191e',
          lightbg: '#eeeeee',
          lightline: '#4a5565',
          darkline: '#d1d5dc',
          get paper_bgcolor() { return this.darkMode ? this.darkbg : this.lightbg; },
          get plot_bgcolor() { return this.darkMode ? this.darkbg : this.lightbg; },
          lighttext: '#d1d5db',
          darktext: '#000000',
          get font() {
            return {
              color: this.darkMode ? this.lighttext : this.darktext
            };
          },
          get axis() {
            return {
              gridcolor: this.darkMode ? this.lightline : this.darkline,
              zerolinecolor: this.darkMode ? this.lightbg : this.darkbg
            };
          },
          denseLayout: false,
        });
        // Playback store for animating through time steps
        Alpine.store('playback', {
          isPlaying: false,
          currentStep: 0,
          maxSteps: 1000,
          fps: 24,
          _raf: null, _last: 0,
          start() {
            if (this._raf) return;
            this.isPlaying = true;
            this._last = performance.now();
            const stepMs = 1000 / this.fps;
            const loop = (t) => {
              if (!this.isPlaying) { this._raf = null; return; }
              const dt = t - this._last;
              if (dt >= stepMs) {
                // Advance by exactly 1 step (no catch-up)
                if (this.currentStep >= this.maxSteps - 1) { this.stop(); return; }
                this.currentStep += 1;
                // prevent drift by carrying over extra time
                // (keeps average fps accurate without multi-step jumps)
                this._last = t - (dt - stepMs);
              }
              this._raf = requestAnimationFrame(loop);
            };
            this._raf = requestAnimationFrame(loop);
          },
          stop(){ this.isPlaying = false; if (this._raf) cancelAnimationFrame(this._raf); this._raf = null; },
          seek(s){ this.currentStep = Math.max(0, Math.min(s, this.maxSteps - 1)); },
        });
        // Visualization options store
        Alpine.store('visOptions', {
          'allOptions': [
            'combatReward',
            'enemyHealth',
            'episodeDetails',
            'episodeImages',
            'friendlyHealth',
            'healthDeathRewards',
            'navigation',
            'overallNavVsCombat',
            'perUnitActions',
            'playbackControls',
            'plotLegends',
            'timelines',
            'valueEstimate',
            'unitsOverTime',
          ],
          'legendPosition': 'horizontal',
          'legendOverlap': 'outside',
          'visible': [],
          init() {
            // Initialize with all options visible
            this.visible = [...this.allOptions];
          },
          plotIsVisible(plotName) {
            if (!this.visible) {
              return false;
            }
            return this.visible.includes(plotName);
          },
          toggleVisibility(plotName) {
            if (!this.visible) {
              this.visible = [];
            }

            if (this.plotIsVisible(plotName)) {
              this.visible = this.visible.filter(item => item !== plotName);
            } else {
              this.visible.push(plotName);
            }
            return this.plotIsVisible(plotName);
          },
          allSelected() {
            return this.visible && this.visible.length === this.allOptions.length;
          },
          toggleAll() {
            if (this.allSelected()) {
              // If all are selected, clear all
              this.visible = [];
            } else {
              // If some or none are selected, select all
              this.visible = [...this.allOptions];
            }
            return this.allSelected();
          }
        });
        Alpine.store('categoricalColors',[
          '#1f77b4',
          '#ff7f0e',
          '#2ca02c',
          '#d62728',
          '#9467bd',
          '#8c564b',
          '#e377c2',
          '#7f7f7f',
          '#bcbd22',
          '#17becf'
        ]);

        // Initialize GA tracking after Alpine is ready
        if (window.GAVisibility) {
          window.GAVisibility.init();
        }
        // Track interactive elements
        if (window.GAButtons) {
          GAButtons.trackClick('button[data-ga-id]');                    // Track buttons with GA IDs
          GAButtons.trackClick('a[data-ga-id]');                        // Track links with GA IDs
          GAButtons.trackCheckbox('input[type="checkbox"]');            // Track all checkboxes
          GAButtons.trackCheckbox('input[type="radio"]');               // Track radio buttons
        }
      });

      // Initialize GA tracking for different loading states
      if (document.readyState !== 'loading') {
        window.GAVisibility && window.GAVisibility.init();
        window.GAButtons && GAButtons.trackClick('button[data-ga-id]');
        window.GAButtons && GAButtons.trackClick('a[data-ga-id]');
        window.GAButtons && GAButtons.trackCheckbox('input[type="checkbox"]');
        window.GAButtons && GAButtons.trackCheckbox('input[type="radio"]');
      } else {
        document.addEventListener('DOMContentLoaded', () => {
          window.GAVisibility && window.GAVisibility.init();
          window.GAButtons && GAButtons.trackClick('button[data-ga-id]');
          window.GAButtons && GAButtons.trackClick('a[data-ga-id]');
          window.GAButtons && GAButtons.trackCheckbox('input[type="checkbox"]');
          window.GAButtons && GAButtons.trackCheckbox('input[type="radio"]');
        });
      }
    </script>
    <title>{% block title %}MIXTAPE{% endblock %}</title>
    <style>
      [x-cloak] {
        display: none;
      }
    </style>
  </head>
  <body class="max-h-screen overflow-hidden" x-data>
    <div>
      {% include "core/toolbar.html" %}
    </div>
    <div>
      {% block content %}{% endblock %}
    </div>
  </body>
</html>
