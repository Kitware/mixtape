<script>
  // Inline Alpine factory for the Insights side panel
  window.insightsSidePanel = function insightsSidePanel() {
    return {
      settingsOpen: false,
      collapsed: false,
      // Defensive getter for the Alpine insights store
      store() {
        try { return this.$store?.insights ?? Alpine.store('insights'); } catch (_) { return null; }
      },
      init() {
        try {
          const store = this.store();
          if (store && typeof store.sidePanelCollapsed !== 'undefined') {
            this.collapsed = !!store.sidePanelCollapsed;
          }
        } catch (_) {}
      },
      toggleSettings() {
        this.settingsOpen = !this.settingsOpen;
      },
      toggleCollapsed() {
        this.collapsed = !this.collapsed;
        try {
          const store = this.store();
          if (store) {
            store.sidePanelCollapsed = this.collapsed;
          } else {
            Alpine.store('insights', { sidePanelCollapsed: this.collapsed });
          }
        } catch (_) {}
      },
      updatePlaybackOnChange($event) {
        const raw = Number($event.target.value);
        const v = Math.min(10, Math.max(0.1, isNaN(raw) ? 1 : raw));
        const rounded = Math.round(v * 10) / 10;
        const store = this.store();
        if (store) {
          store.playbackSpeed = rounded;
        }
        $event.target.value = rounded.toFixed(1);
      },
      updatePlaybackOnInput($event) {
        const raw = Number($event.target.value);
        const store = this.store();
        if (!isNaN(raw) && store) {
          const v = Math.min(10, Math.max(0.1, raw));
          const rounded = Math.round(v * 10) / 10;
          store.playbackSpeed = rounded;
        }
      },
      setGlobalTimeline(v) {
        const store = this.store();
        if (store) {
          store.useGlobalTimeline = v;
        }
      },
      setTimelineEpisodeIdx($event) {
        const store = this.store();
        if (store) {
          store.timelineEpisodeIdx = +$event.target.value;
        }
      },
    };
  };
</script>
