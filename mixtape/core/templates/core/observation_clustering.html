<div
  x-data="{
    data: [],
    layout: {
      title: {text: 'Agent Observations'},
      height: 450,
      xaxis: {
        showticklabels: false,
        gridcolor: $store.theme.darkMode ? '#4a5565' : '#d1d5dc',
        zerolinecolor: $store.theme.darkMode ? '#F1F2F6' : '#111827'
      },
      yaxis: {
        showticklabels: false,
        gridcolor: $store.theme.darkMode ? '#4a5565' : '#d1d5dc',
        zerolinecolor: $store.theme.darkMode ? '#F1F2F6' : '#111827'
      },
      paper_bgcolor: $store.theme.darkMode ? '#111827' : '#F1F2F6',
      plot_bgcolor: $store.theme.darkMode ? '#111827' : '#F1F2F6',
      font: {
        color: $store.theme.darkMode ? '#D1D5DB' : '#000000'
      },
    },
    plot: null,
  }"
  x-init="
    data = [];
    for (let agent_idx = 0; agent_idx < plotData.unique_agents.length; agent_idx++) {
      data.push({
        x: plotData.clustering.episode_manifolds[0].map(row => row[agent_idx][0]),
        y: plotData.clustering.episode_manifolds[0].map(row => row[agent_idx][1]),
        type: 'scatter',
        mode: 'lines',
        colorscale: 'YlOrRd',
        line: {
          opacity: 1,
          width: 2
        },
        name: plotData.unique_agents[agent_idx]
      });
    }
    data.push({
      x: plotData.clustering.all_manifolds_x,
      y: plotData.clustering.all_manifolds_y,
      type: 'scatter',
      mode: 'markers',
      showlegend: false,
      marker: {
        color: plotData.clustering.all_clusters,
        cmin: 0,
        cmax: 9,
        colorscale: 'Viridis',
        size: 20,
        opacity: Array(plotData.clustering.all_manifolds_x.length).fill(1)
      }
    })
    plot = Plotly.newPlot($refs.allManifolds, data, layout, {displayModeBar: false})"
  x-effect="
    if (plot) {
      const numAgents = plotData.unique_agents.length;
      const startIdx = currentStep * numAgents;
      const endIdx = startIdx + numAgents;

      // Get the current plot data from the DOM element
      const plotElement = $refs.allManifolds;
      const currentData = plotElement.data;

      // Remove the highlight trace if it exists (it will be last, at index 1 + numAgents)
      if (currentData && currentData.length > (1 + numAgents)) {
        Plotly.deleteTraces($refs.allManifolds, [1 + numAgents]);
      }

      // Create arrays for the highlighted points
      const highlightX = [];
      const highlightY = [];
      const highlightColors = [];
      const highlightText = [];

      for (let i = startIdx; i < endIdx; i++) {
        const agentIdx = i - startIdx;
        const agentTrace = currentData[agentIdx];
        // Only add points for visible traces
        if (agentTrace && (!agentTrace.visible || agentTrace.visible === true)) {
          highlightX.push(plotData.clustering.all_manifolds_x[i]);
          highlightY.push(plotData.clustering.all_manifolds_y[i]);
          highlightText.push(plotData.unique_agents[agentIdx]);
        }
      }

      // Only add the highlight trace if there are visible points
      if (highlightX.length > 0) {
        // Add new trace for highlighted points
        const textPosition = ['top left', 'middle left', 'bottom left', 'top center', 'middle center', 'bottom center', 'top right', 'middle right', 'bottom right'];
        Plotly.addTraces($refs.allManifolds, [{
          x: highlightX,
          y: highlightY,
          text: highlightText,
          type: 'scatter',
          mode: 'markers+text',
          showlegend: false,
          textposition: textPosition,
          textfont: {
            size: 12,
            color: $store.theme.darkMode ? '#D1D5DB' : '#000000'
          },
          marker: {
            color: 'transparent',
            size: 20,
            line: {
              width: 3,
              color: 'red'
            }
          }
        }]);
      }
    }"
>
  <div x-ref="allManifolds"></div>
</div>
