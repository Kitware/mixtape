<div
  x-data="insightsTabs"
  x-cloak
  class="
    grow
    bg-base-100
    rounded-lg
    shadow-md
  "
>
  <div
    class="
      flex items-center justify-between
      border-b border-base-300
      px-2 pt-2 gap-2
    "
  >
    <div role="tablist" aria-label="Insights Tabs" class="tabs tabs-border">
      <button
        id="tab-overview"
        role="tab"
        :aria-selected="active==='Overview'"
        aria-controls="panel-overview"
        @click="selectTab('Overview')"
        class="tab px-3 py-2"
        :class="{ 'tab-active': active === 'Overview' }"
      >Overview</button>
      <button
        id="tab-rewards"
        role="tab"
        :aria-selected="active==='Rewards'"
        aria-controls="panel-rewards"
        @click="selectTab('Rewards')"
        class="tab px-3 py-2"
        :class="{ 'tab-active': active === 'Rewards' }"
      >Rewards</button>
      <button
        id="tab-agents"
        role="tab"
        :aria-selected="active==='Agents'"
        aria-controls="panel-agents"
        @click="selectTab('Agents')"
        class="tab px-3 py-2"
        :class="{ 'tab-active': active === 'Agents' }"
      >Agents
        <span
          class="ml-2 loading loading-spinner loading-xs text-primary"
          x-show="
            ($store.insights.episodeIds.length > 1 && !$store.insights.clustering)
            || ($store.insights.episodeIds.length === 1 && (!$store.insights.clustering || !$store.insights.clustering?.obs || !$store.insights.clustering?.agent_outs))
          "
          x-cloak
        ></span>
      </button>
    </div>
    <div class="flex items-center gap-2 flex-wrap">
      <span class="badge badge-soft badge-primary" :title="`${$store.insights.episodeIds.length} Episodes`">
        <i class="ri-checkbox-multiple-blank-line"></i>
        <span class="font-semibold" x-text="$store.insights.episodeIds.length"></span>
      </span>
      <span class="badge badge-soft badge-primary" :title="`${$store.insights.uniqueAgents.length} Agents`">
        <i class="ri-robot-2-line"></i>
        <span class="font-semibold" x-text="$store.insights.uniqueAgents.length"></span>
      </span>
      <span class="badge badge-soft badge-primary" :title="`Avg Reward: ${avgRewardDisplay ?? '—'}`">
        <i class="ri-trophy-line"></i>
        <span class="font-semibold" x-text="avgRewardDisplay ?? '—'"></span>
      </span>
      <span class="badge badge-soft badge-primary"
            :title="maxStepsTooltip()">
        <i class="ri-timer-line"></i>
        <span class="font-semibold" x-text="maxStepsCount ?? '—'"></span>
      </span>
    </div>
  </div>
  <div class="p-4 flex flex-col gap-2">
    <div x-show="active==='Overview'" x-cloak id="panel-overview" role="tabpanel" aria-labelledby="tab-overview">
      <div class="flex flex-row gap-2">
        <section
          class="flex-1 w-0 border border-base-300 rounded-lg p-3"
          x-show="$store.settings.showPlotRewardFrequency"
        >
          <div class="min-h-[18rem]">
            <div x-data="rewardsFrequency" x-ref="rewardsFrequency" x-resize="resizePlot" class="w-full"></div>
          </div>
        </section>
        <section
          class="flex-1 w-0 border border-base-300 rounded-lg p-3"
          x-show="$store.settings.showPlotActionFrequency"
        >
          <div class="min-h-[18rem]">
            <div x-data="actionsFrequency" x-ref="actionsFrequency" x-resize="resizePlot" class="w-full"></div>
          </div>
        </section>
        <section
          class="flex-1 w-0 border border-base-300 rounded-lg p-3"
          x-show="$store.settings.showPlotActionRewardFrequency"
        >
          <div class="min-h-[18rem]">
            <div x-data="actionsRewards" x-ref="actionsRewards" x-resize="resizePlot" class="w-full"></div>
          </div>
        </section>
      </div>
    </div>

    <div x-show="active==='Rewards'" x-cloak id="panel-rewards" role="tabpanel" aria-labelledby="tab-rewards">
      <div class="flex flex-row gap-2">
        <section
          class="flex-1 w-0 border border-base-300 rounded-lg p-3"
          x-show="$store.settings.showPlotRewardsTime"
        >
          <div class="min-h-[18rem]">
            <div x-data="rewardsOverTime" x-ref="rewardsOverTime" x-resize="resizePlot" class="w-full"></div>
          </div>
        </section>
        {% if has_reward_mapping %}
        <section
          class="flex-1 w-0 border border-base-300 rounded-lg p-3"
          x-show="$store.settings.showPlotRewardsTime"
        >
          <div class="min-h-[18rem]">
            <div x-data="rewardsOverTimeDecomp" x-ref="rewardsOverTime" x-resize="resizePlot"></div>
          </div>
        </section>
        {% endif %}
      </div>
    </div>

    <div x-show="active==='Agents'" id="panel-agents" role="tabpanel" aria-labelledby="tab-agents">
      <div class="flex flex-row gap-2">
        <section
          class="flex-1 w-0 border border-base-300 rounded-lg p-3"
          x-show="$store.settings.showPlotObservationClustering"
        >
          <h3 class="text-sm font-medium mb-2">Observations</h3>
          <div
            class="flex justify-center"
            style="height: calc(100% - 20px);"
            x-show="
              ($store.insights.episodeIds.length > 1 && !$store.insights.clustering) || ($store.insights.episodeIds.length === 1 && !($store.insights.clustering && $store.insights.clustering.obs))
            "
            x-cloak
          >
            <div class="loading loading-spinner loading-xl text-primary" aria-hidden="true"></div>
          </div>
          <div class="space-y-3">
            <div>
              <div
                class="skeleton h-[450px] w-full"
                x-show="!($store.insights.clustering && $store.insights.clustering.obs)"
                x-cloak
              ></div>
              <div
                x-data="clustering('obs', 'Observations')" x-resize="resizePlot" x-ref="allManifolds"
                x-show="$store.insights.clustering && $store.insights.clustering.obs"
                class="w-full"
                x-cloak
              ></div>
            </div>
            {% include "core/insights/clustering_timeline.html" with key="'obs'" title="Observations" %}
          </div>
        </section>
        <section
          class="flex-1 w-0 border border-base-300 rounded-lg p-3"
          x-show="$store.settings.showPlotActionClustering"
        >
          <h3 class="text-sm font-medium mb-2">Actions</h3>
          <div
            class="flex justify-center"
            style="height: calc(100% - 20px);"
            x-show="
              ($store.insights.episodeIds.length > 1 && !$store.insights.clustering) || ($store.insights.episodeIds.length === 1 && !($store.insights.clustering && $store.insights.clustering.agent_outs))
            "
            x-cloak
          >
            <div class="loading loading-spinner loading-xl text-primary" aria-hidden="true"></div>
          </div>
          <div class="space-y-3">
            <div>
              <div
                class="skeleton h-[450px] w-full"
                x-show="!($store.insights.clustering && $store.insights.clustering.agent_outs)"
                x-cloak
              ></div>
              <div
                x-data="clustering('agent_outs', 'Actions')" x-resize="resizePlot" x-ref="allManifolds"
                x-show="$store.insights.clustering && $store.insights.clustering.agent_outs"
                class="w-full"
                x-cloak
              ></div>
            </div>
            {% include "core/insights/clustering_timeline.html" with key="'agent_outs'" title="Actions" %}
          </div>
        </section>
      </div>
    </div>
    <div x-show="$store.settings.showPlayback" x-cloak>
      {% include "core/insights/replay_controls.html" %}
    </div>
    <div x-show="$store.settings.showTimeline" x-cloak>
      {% include "core/insights/timeline.html" %}
    </div>
    <div class="flex flex-row gap-2">
      <div x-show="$store.settings.showEpisodeInfo" x-cloak class="flex-1">
        {% include "core/insights/episode_info.html" %}
      </div>
      <div x-show="$store.settings.showMediaViewer" x-cloak class="flex-2">
        {% include "core/insights/media_viewer.html" %}
      </div>
    </div>
    <!-- Toast notification -->
    <div
      class="toast"
      x-show="showToast"
      x-transition
      x-cloak
      role="status"
      aria-live="polite"
    >
      <div role="alertdialog" class="alert alert-info alert-soft">
        <i class="ri-check-line"></i>
        <span x-text="toastText"></span>
        <button
          type="button"
          class="ml-2 text-sm opacity-70 hover:opacity-100"
          @click="showToast=false"
          aria-label="Dismiss notification"
        >✕</button>
      </div>
    </div>
  </div>
</div>
