{% load static %}
<script src="{% static 'mixtape/core/insights/insightsTabs.js' %}"></script>
<script src="{% static 'mixtape/core/insights/rewardsOverTimeDecomp.js' %}"></script>
<script src="{% static 'mixtape/core/insights/rewardsFrequency.js' %}"></script>
<div
  x-data="insightsTabs"
  x-cloak
  class="
    grow
    bg-[var(--color-surface)]
    text-[var(--color-surface-foreground)]
    rounded-lg
    border
    border-[var(--color-border)]
    shadow-md
  "
>
  <div
    class="
      flex items-center justify-between
      border-b border-[var(--color-border)]
      px-2 pt-2 gap-2
    "
  >
    <div role="tablist" aria-label="Insights Tabs" class="tabs tabs-border">
      <button
        id="tab-overview"
        role="tab"
        :aria-selected="active==='Overview'"
        aria-controls="panel-overview"
        @click="selectTab('Overview')"
        class="tab px-3 py-2"
        :class="{ 'tab-active': active === 'Overview' }"
      >Overview</button>
      <button
        id="tab-actions"
        role="tab"
        :aria-selected="active==='Actions'"
        aria-controls="panel-actions"
        @click="selectTab('Actions')"
        class="tab px-3 py-2"
        :class="{ 'tab-active': active === 'Actions' }"
      >Actions</button>
      <button
        id="tab-rewards"
        role="tab"
        :aria-selected="active==='Rewards'"
        aria-controls="panel-rewards"
        @click="selectTab('Rewards')"
        class="tab px-3 py-2"
        :class="{ 'tab-active': active === 'Rewards' }"
      >Rewards</button>
      <button
        id="tab-agents"
        role="tab"
        :aria-selected="active==='Agents'"
        aria-controls="panel-agents"
        @click="selectTab('Agents')"
        class="tab px-3 py-2"
        :class="{ 'tab-active': active === 'Agents' }"
      >Agents
        <span
          class="ml-2 inline-flex items-center"
          x-show="
            Array.isArray(episodeIds)
            && (
              (episodeIds.length > 1 && !clustering)
              || (episodeIds.length === 1 && (!clustering || !clustering?.obs || !clustering?.agent_outs))
            )
          "
          x-cloak
        >
          <span
            class="w-3 h-3 border-2 border-[var(--color-border)] border-t-[var(--color-accent)] rounded-full animate-spin"
            aria-hidden="true"
          ></span>
        </span>
      </button>
    </div>
    <div class="flex items-center gap-2 flex-wrap">
      <span class="badge badge-soft badge-primary" :title="`${episodesCount ?? '—'} Episodes`">
        <i class="ri-checkbox-multiple-blank-line text-[var(--color-accent)]"></i>
        <span class="font-semibold" x-text="episodesCount ?? '—'"></span>
      </span>
      <span class="badge badge-soft badge-primary" :title="`${agentsCount ?? '—'} Agents`">
        <i class="ri-robot-2-line text-[var(--color-accent)]"></i>
        <span class="font-semibold" x-text="agentsCount ?? '—'"></span>
      </span>
      <span class="badge badge-soft badge-primary" :title="`Avg Reward: ${avgRewardDisplay ?? '—'}`">
        <i class="ri-trophy-line text-[var(--color-accent)]"></i>
        <span class="font-semibold" x-text="avgRewardDisplay ?? '—'"></span>
      </span>
      <span class="badge badge-soft badge-primary"
            :title="maxStepsTooltip()">
        <i class="ri-timer-line text-[var(--color-accent)]"></i>
        <span class="font-semibold" x-text="maxStepsCount ?? '—'"></span>
      </span>
    </div>
  </div>
  <div class="p-4">
    <div x-show="active==='Overview'" x-cloak id="panel-overview" role="tabpanel" aria-labelledby="tab-overview" class="space-y-4">
      <div
        class="grid grid-cols-1 gap-2 grid-flow-row-dense"
        x-show="overviewVisible()"
        :class="overviewGridColsClass()"
      >
        <section
          class="card p-3"
          x-show="$store.settings.showPlotRewardFrequency"
        >
          <div class="min-h-[18rem]">
            <div x-data="rewardsFrequency" x-ref="rewardsFrequency" x-resize="resizePlot" class="w-full"></div>
          </div>
        </section>
        <section
          class="card p-3"
          x-show="$store.settings.showPlotActionFrequency"
        >
          <div class="min-h-[18rem]">
            {% include "core/insights/action_v_frequency.html" %}
          </div>
        </section>
        <section
          class="card p-3 lg:col-span-1"
          x-show="$store.settings.showPlotActionRewardFrequency"
        >
          <div class="min-h-[18rem]">
            {% include "core/insights/action_v_reward_frequency.html" %}
          </div>
        </section>
      </div>
    </div>
    <div x-show="active==='Actions'" x-cloak id="panel-actions" role="tabpanel" aria-labelledby="tab-actions" class="space-y-4">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-2">
        <section
          class="card p-3"
          x-show="$store.settings.showPlotActionFrequency"
          :class="$store.settings.showPlotActionRewardFrequency ? 'lg:col-span-2' : ''"
        >
          <div class="min-h-[18rem]">
            {% include "core/insights/action_v_frequency.html" %}
          </div>
        </section>
        <section
          class="card p-3"
          x-show="$store.settings.showPlotActionRewardFrequency"
          :class="$store.settings.showPlotActionFrequency ? 'lg:col-span-2' : ''"
        >
          <div class="min-h-[18rem]">
            {% include "core/insights/action_v_reward_frequency.html" %}
          </div>
        </section>
      </div>
    </div>

    <div x-show="active==='Rewards'" x-cloak id="panel-rewards" role="tabpanel" aria-labelledby="tab-rewards" class="space-y-4">
      <div class="grid grid-cols-1 {% if has_reward_mapping %}lg:grid-cols-2{% endif %} gap-2">
        <section
          class="card p-3"
          x-show="$store.settings.showPlotRewardsTime"
        >
          <div class="min-h-[18rem]">
            {% include "core/insights/rewards_over_time.html" %}
          </div>
        </section>
        {% if has_reward_mapping %}
        <section
          class="card p-3"
          x-show="$store.settings.showPlotRewardsTime"
        >
          <div class="min-h-[18rem]">
            <div x-data="rewardsOverTime" x-ref="rewardsOverTime" x-resize="resizePlot"></div>
          </div>
        </section>
        {% endif %}
      </div>
    </div>

    <div x-show="active==='Agents'" id="panel-agents" role="tabpanel" aria-labelledby="tab-agents" class="space-y-4">
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-2">
        <section
          class="card p-3"
          x-show="$store.settings.showPlotObservationClustering"
          :class="!$store.settings.showPlotActionClustering ? 'xl:col-span-2' : ''"
        >
          <h3 class="text-sm font-medium mb-2">Observations</h3>
          <div
            class="justify-items-center content-center"
            style="height: calc(100% - 20px);"
            x-show="
              Array.isArray(episodeIds)
              && ((episodeIds.length > 1 && !clustering) || (episodeIds.length === 1 && !(clustering && clustering.obs)))
            "
            x-cloak
          >
            <div
              class="w-25 h-25 border-2 border-[var(--color-border)] border-t-[var(--color-accent)] rounded-full animate-spin"
              aria-hidden="true"
            ></div>
          </div>
          <div class="space-y-3">
            {% include "core/insights/clustering.html" with key="'obs'" title="Observations" %}
            {% include "core/insights/clustering_timeline.html" with key="'obs'" title="Observations" %}
          </div>
        </section>
        <section
          class="card p-3"
          x-show="$store.settings.showPlotActionClustering"
          :class="!$store.settings.showPlotObservationClustering ? 'xl:col-span-2' : ''"
        >
          <h3 class="text-sm font-medium mb-2">Actions</h3>
          <div
            class="justify-items-center content-center"
            style="height: calc(100% - 20px);"
            x-show="
              Array.isArray(episodeIds)
              && ((episodeIds.length > 1 && !clustering) || (episodeIds.length === 1 && !(clustering && clustering.agent_outs)))
            "
            x-cloak
          >
            <div
              class="w-25 h-25 border-2 border-[var(--color-border)] border-t-[var(--color-accent)] rounded-full animate-spin"
              aria-hidden="true"
            ></div>
          </div>
          <div class="space-y-3">
            {% include "core/insights/clustering.html" with key="'agent_outs'" title="Actions" %}
            {% include "core/insights/clustering_timeline.html" with key="'agent_outs'" title="Actions" %}
          </div>
        </section>
      </div>
    </div>
    <div
      class="mt-1 mx-1"
      x-show="$store.settings.showPlayback" x-cloak
    >
      {% include "core/insights/replay_controls.html" %}
    </div>
    <div
      class="mt-2"
      x-show="$store.settings.showTimeline" x-cloak
    >
      <section class="card">
        {% include "core/insights/timeline.html" %}
      </section>
    </div>
    <div class="mt-2">
      <div class="flex gap-2">
        <section
          class="flex-1 card p-3 h-auto"
          x-show="$store.settings.showEpisodeInfo" x-cloak
        >
          {% include "core/insights/episode_info.html" %}
        </section>
        <section
          class="flex-1 card p-3 h-full"
          x-show="$store.settings.showMediaViewer" x-cloak
        >
          <div class="h-full">
            {% include "core/insights/media_viewer.html" %}
          </div>
        </section>
      </div>
    </div>
    <!-- Toast notification -->
    <div
      class="fixed bottom-4 right-4 z-50"
      x-show="showToast"
      x-transition
      x-cloak
      role="status"
      aria-live="polite"
    >
      <div
        class="
          flex items-center gap-2 px-3 py-2
          bg-[var(--color-surface)] text-[var(--color-surface-foreground)]
          border border-[var(--color-border)] rounded-md shadow-lg
        "
      >
        <i class="ri-check-line text-[var(--color-accent)]"></i>
        <span x-text="toastText"></span>
        <button
          type="button"
          class="ml-2 text-sm opacity-70 hover:opacity-100"
          @click="showToast=false"
          aria-label="Dismiss notification"
        >✕</button>
      </div>
    </div>
  </div>
</div>
