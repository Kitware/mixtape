<script>
  // Factory for Insights side panel
  window.insightsSidePanel = function insightsSidePanel() {
    return {
      settingsOpen: false,
      collapsed: false,
      normalizeSpeed(v) {
        const n = Number(v);
        const clamped = Math.min(10, Math.max(0.1, isNaN(n) ? 1 : n));
        return Math.round(clamped * 10) / 10;
      },
      store() {
        return this.$store?.insights ?? (
          window.Alpine ? Alpine.store('insights') : null
        );
      },
      init() {
        const store = this.store();
        if (store && typeof store.sidePanelCollapsed !== 'undefined') {
          this.collapsed = !!store.sidePanelCollapsed;
        }
      },
      toggleSettings() {
        this.settingsOpen = !this.settingsOpen;
      },
      toggleCollapsed() {
        this.collapsed = !this.collapsed;
        const store = this.store();
        if (store) {
          store.sidePanelCollapsed = this.collapsed;
        }
      },
      updatePlaybackOnChange($event) {
        const rounded = this.normalizeSpeed($event.target.value);
        const store = this.store();
        if (store) {
          store.playbackSpeed = rounded;
        }
        $event.target.value = rounded.toFixed(1);
      },
      updatePlaybackOnInput($event) {
        const store = this.store();
        if (store) {
          const rounded = this.normalizeSpeed($event.target.value);
          store.playbackSpeed = rounded;
        }
      },
      setGlobalTimeline(v) {
        const store = this.store();
        if (store) {
          store.useGlobalTimeline = v;
        }
      },
      setTimelineEpisodeIdx($event) {
        const store = this.store();
        if (store) {
          store.timelineEpisodeIdx = +$event.target.value;
        }
      },
    };
  };
</script>
