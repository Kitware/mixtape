<div
  x-data="{
    data: [],
    layout: {
      ...basePlotLayout,
      title: {text: 'Per-Unit Actions Over Time'},
      xaxis: { ...basePlotLayout.xaxis, title: {text: 'Time Step'} },
      yaxis: { ...basePlotLayout.yaxis, title: {text: 'Units'}, type: 'category' },
      margin: {l: 100, r: 40, t: 40, b: 40},
      showlegend: false,
      showscale: $store.visOptions.visible.includes('plotLegends'),
    },
    plot: null,
    units: [],
  }"
  x-init="
    const unitMapping = parsedData.unit_mapping || [];
    const unitActions = parsedData.unit_actions || [];
    const episodeIds = parsedData.episode_ids || [];
    const timeSteps = [];
    let prefixedUnits = [];
    const z = [];

    // Process each episode
    unitActions.forEach((episodeActions, idx) => {
      if (!episodeActions) return;

      const ep = unitActions.length > 1 ? `ep ${episodeIds[idx]} - ` : '';
      const episodeUnits = Object.keys(episodeActions).sort();

      // Collect all time steps for this episode
      episodeUnits.forEach(unit => {
        episodeActions[unit].forEach(stepData => {
          if (!timeSteps.includes(stepData.step)) {
            timeSteps.push(stepData.step);
          }
        });
      });

      // Create prefixed unit names
      prefixedUnits = [...prefixedUnits, ...episodeUnits.map(unit => `${ep}${unit}`)];
      units = [...units, ...prefixedUnits];

      // Create z-data for heatmap
      episodeUnits.forEach(unit => {
        const unitRow = [];
        timeSteps.forEach(step => {
          const actionData = episodeActions[unit].find(d => d.step === step);
          const action = actionData ? (actionData.action === null ? -1 : actionData.action) : -1;
          unitRow.push(action);
        });
        z.push(unitRow);
      });
    });

    // Add this episode's data
    data.push({
      z: z,
      x: timeSteps,
      y: prefixedUnits,
      type: 'heatmap',
      colorscale: [
        [0, '#00000000'],
        [.25, '#00000000'],  // Transparent - Dead
        [0.25, '#1f77b4'],
        [0.5, '#1f77b4'],    // Blue - Noop
        [0.5, '#ff7f0e'],
        [0.75, '#ff7f0e'],   // Orange - Move
        [0.75, '#2ca02c'],
        [1, '#2ca02c'],      // Green - Attack
      ],
      colorbar: {
        title: 'Action',
        tickmode: 'array',
        tickvals: [-1, 0, 1, 2],
        ticktext: ['Dead', 'Noop', 'Move', 'Attack'],
      },
    });

    plot = Plotly.react($refs.unitActionsPlot, data, layout, basePlotConfig);
    $watch('$store.visOptions', () => {
      $nextTick(() => {
        Plotly.relayout(
          $refs.unitActionsPlot,
          {
            autosize: true,
            showlegend: $store.visOptions.visible.includes('plotLegends'),
            legend: legendLayout(),
          });
      });
    });
  "
  x-effect="
    if (plot) {
      Plotly.relayout($refs.unitActionsPlot, {
        ...basePlotStyling(),
      });
    }
  "
  class="w-full"
>
  <div x-ref="unitActionsPlot"></div>
</div>
