<aside x-data="{ settingsOpen: false, collapsed: false }"
       class="u-bg-surface u-text-surface rounded-lg p-3 w-full lg:w-auto lg:sticky lg:top-4 lg:max-h-[calc(100vh-2rem)] lg:overflow-auto transition-all"
       :class="collapsed ? 'px-1 py-2 w-12 overflow-hidden' : ''">
  <div x-show="!collapsed" x-cloak>
    <div class="flex items-center justify-between mb-2">
      <span class="text-sm font-semibold tracking-wide">MIXTAPE</span>
      <a href="/" class="btn btn-icon u-text-accent" title="Home">
        <i class="ri-home-4-line"></i>
      </a>
    </div>
    <hr class="u-border-surface mb-2" />
  </div>
  <header class="flex items-center justify-between mb-3"
          x-init="(() => { try { if ($store.insights && typeof $store.insights.sidePanelCollapsed !== 'undefined') { collapsed = !!$store.insights.sidePanelCollapsed; } } catch(_){} })()">
    <h3 class="text-base font-semibold" x-show="!collapsed">Settings & Tools</h2>
    <div class="flex items-end gap-2">
      <button class="btn btn-icon u-text-accent" x-show="!collapsed" x-cloak title="Settings" @click="settingsOpen = !settingsOpen" :aria-expanded="settingsOpen">
        <i class="ri-settings-3-line"></i>
      </button>
      <button class="btn btn-icon" :class="collapsed ? 'u-text-muted' : 'u-text-accent'" title="Collapse"
              @click="collapsed = !collapsed; try { if ($store.insights) { $store.insights.sidePanelCollapsed = collapsed; } else { Alpine.store('insights', { sidePanelCollapsed: collapsed }); } } catch(_){}" :aria-expanded="!collapsed">
        <i class="ri-menu-fold-line" :class="collapsed ? 'rotate-180' : 'rotate-0'"></i>
      </button>
    </div>
  </header>

  <div x-show="!settingsOpen && !collapsed" x-cloak class="space-y-2">
    <section class="card p-3">
      <h3 class="text-sm font-medium mb-2">Selected Episodes</h3>
      <ul class="text-sm space-y-1">
        <template x-if="$store.insights && Array.isArray($store.insights.episodeSummaries) && $store.insights.episodeSummaries.length">
          <template x-for="(ep, idx) in $store.insights.episodeSummaries" :key="idx">
            <li class="flex items-center justify-between">
              <span x-text="'Episode ' + (ep?.id ?? idx)"></span>
            </li>
          </template>
        </template>
      </ul>
    </section>
  </div>

  <div class="space-y-3" x-show="!collapsed" x-cloak>
    <section class="card p-3" x-show="settingsOpen" x-cloak>
      <h3 class="text-sm font-medium mb-2">Playback</h3>
      <div class="flex items-center gap-2">
        <label class="text-sm w-24">Speed</label>
        <input type="number" min="0.1" max="10" step="0.1"
               class="w-15 rounded-md border u-border-surface u-bg-surface px-2 py-1 text-sm text-right"
               :value="($store.insights && typeof $store.insights.playbackSpeed === 'number' ? $store.insights.playbackSpeed.toFixed(1) : '1.0')"
               @change="(() => { const raw = Number($event.target.value); const v = Math.min(10, Math.max(0.1, isNaN(raw) ? 1 : raw)); const rounded = Math.round(v * 10) / 10; if ($store.insights) { $store.insights.playbackSpeed = rounded; } $event.target.value = rounded.toFixed(1); })()"
               @input="(() => { const raw = Number($event.target.value); if (!isNaN(raw) && $store.insights) { const v = Math.min(10, Math.max(0.1, raw)); const rounded = Math.round(v * 10) / 10; $store.insights.playbackSpeed = rounded; } })()" />
        <span class="text-sm">x Speed</span>
      </div>
    </section>

    <section class="card p-3" x-show="settingsOpen && $store.insights && Array.isArray($store.insights.episodeSummaries) && $store.insights.episodeSummaries.length > 1" x-cloak>
      <h3 class="text-sm font-medium mb-2">Timeline</h3>
        <div class="flex items-center gap-2 mb-2">
          <label class="flex items-center gap-2 text-sm">
            <input type="radio" name="timeline-mode" class="radio"
                   :checked="$store.insights ? ($store.insights.useGlobalTimeline === true) : true"
                   @change="if ($store.insights) { $store.insights.useGlobalTimeline = true; }" />
            Use global timeline
          </label>
        </div>
        <div class="flex items-center gap-2">
          <label class="flex items-center gap-2 text-sm">
            <input type="radio" name="timeline-mode" class="radio"
                   :checked="$store.insights ? ($store.insights.useGlobalTimeline === false) : false"
                   @change="if ($store.insights) { $store.insights.useGlobalTimeline = false; }" />
            Use episode timeline
          </label>
          <select class="rounded-md border px-2 py-1 text-sm"
                  :class="(($store.insights && $store.insights.useGlobalTimeline !== false)
                            ? 'opacity-50 cursor-not-allowed u-border-surface u-bg-muted'
                            : 'u-border-surface u-bg-surface')"
                  :disabled="(!$store.insights) || ($store.insights.useGlobalTimeline !== false)"
                  :value="$store.insights ? $store.insights.timelineEpisodeIdx : 0"
                  @change="if ($store.insights) { $store.insights.timelineEpisodeIdx = +$event.target.value; }">
            <template x-for="(ep, idx) in ($store.insights && Array.isArray($store.insights.episodeSummaries) ? $store.insights.episodeSummaries : [])" :key="idx">
              <option :value="idx" x-text="'Episode ' + (ep?.id ?? idx)"></option>
            </template>
          </select>
        </div>
    </section>

    <section class="card p-3" x-show="settingsOpen" x-cloak>
      <h3 class="text-sm font-medium mb-2">Visibility</h3>
      <div class="space-y-3">
        <div>
          <h4 class="text-xs u-text-muted mb-1">Global</h4>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && Array.isArray($store.insights.visOptions) && $store.insights.visOptions.includes('showPlayback')"
                     @change="$store.insights && $store.insights.toggleVis('showPlayback')" />
              Playback Controls
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && Array.isArray($store.insights.visOptions) && $store.insights.visOptions.includes('showEpisodeInfo')"
                     @change="$store.insights && $store.insights.toggleVis('showEpisodeInfo')" />
              Episode Info
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && Array.isArray($store.insights.visOptions) && $store.insights.visOptions.includes('showMediaViewer')"
                     @change="$store.insights && $store.insights.toggleVis('showMediaViewer')" />
              Media Viewer
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && Array.isArray($store.insights.visOptions) && $store.insights.visOptions.includes('showTimeline')"
                     @change="$store.insights && $store.insights.toggleVis('showTimeline')" />
              Timeline
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('plotLegends')"
                     @change="$store.insights.toggleVis('plotLegends')" />
              Plot Legends
            </label>
          </div>
        </div>
        <div>
          <h4 class="text-xs u-text-muted mb-1">Overview</h4>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('actionRewardFrequency')"
                     @change="$store.insights.toggleVis('actionRewardFrequency')" />
              Action vs Reward
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('rewardFrequency')"
                     @change="$store.insights.toggleVis('rewardFrequency')" />
              Reward Frequency
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('actionFrequency')"
                     @change="$store.insights.toggleVis('actionFrequency')" />
              Action Frequency
            </label>
          </div>
        </div>
        <div>
          <h4 class="text-xs u-text-muted mb-1">Rewards</h4>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('rewardsOverTime')"
                     @change="$store.insights.toggleVis('rewardsOverTime')" />
              Rewards Over Time
            </label>
          </div>
        </div>
        <div>
          <h4 class="text-xs u-text-muted mb-1">Agents</h4>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('obsClustering')"
                     @change="$store.insights.toggleVis('obsClustering')" />
              Observation Clustering
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('actionClustering')"
                     @change="$store.insights.toggleVis('actionClustering')" />
              Action Clustering
            </label>
          </div>
        </div>
      </div>
    </section>
  </div>
</aside>
