{% extends "core/base.html" %}
{% load resonant_utils static %}
{% block title %}MIXTAPE Home{% endblock %}
{% block extra_head %}
    <script defer>
// Home page Alpine.js component for episode filtering and selection
document.addEventListener('alpine:init', () => {
    Alpine.data('episodeManager', () => ({
        // State
        selectedEpisodes: [],
        allowedEnvironment: null,
        selectedAlgorithms: [],
        selectedEnvironments: [],
        searchQuery: '',
        sortOrder: 'newest',
        
        init() {
            // Watch for changes and trigger filtering
            this.$watch('searchQuery', () => this.filterEpisodes());
            this.$watch('selectedAlgorithms', () => this.filterEpisodes());
            this.$watch('selectedEnvironments', () => this.filterEpisodes());
            this.$watch('sortOrder', () => this.filterEpisodes());
            
            // Apply filters on page load (handles browser back button)
            this.$nextTick(() => {
                this.filterEpisodes();
            });
        },

        // Computed properties
        get hasActiveFilters() {
            return this.searchQuery.trim() !== '' || 
                   this.selectedAlgorithms.length > 0 || 
                   this.selectedEnvironments.length > 0 || 
                   this.sortOrder !== 'newest';
        },

        get hasSelectedEpisodes() {
            return this.selectedEpisodes.length > 0;
        },

        // Episode selection logic
        updateAllowedEnvironment(env) {
            if (this.selectedEpisodes.length === 0) {
                this.allowedEnvironment = null;
            } else {
                this.allowedEnvironment = env;
            }
        },

        selectAllMatchingEnvironment() {
            if (!this.allowedEnvironment) return;
            
            // Only select from visible episodes (not hidden by filters)
            const visibleEpisodes = document.querySelectorAll('[data-episode-id]:not([style*="display: none"])');
            const matchingCheckboxes = Array.from(visibleEpisodes)
                .filter(episode => episode.dataset.environment === this.allowedEnvironment)
                .map(episode => episode.querySelector('input[type=checkbox]'))
                .filter(checkbox => checkbox); // Remove null entries
            
            this.selectedEpisodes = matchingCheckboxes.map(cb => cb.value);
        },

        clearAllSelections() {
            this.selectedEpisodes = [];
            this.allowedEnvironment = null;
        },

        // Filter management
        clearAllFilters() {
            this.searchQuery = '';
            this.selectedAlgorithms = [];
            this.selectedEnvironments = [];
            this.sortOrder = 'newest';
        },

        // Navigation
        viewSelectedEpisodes() {
            const baseUrl = document.querySelector('[data-insights-url]').dataset.insightsUrl;
            const params = this.selectedEpisodes.map(id => `episode_id=${id}`).join('&');
            window.location.href = `${baseUrl}?${params}`;
        },

        // Filtering logic
        filterEpisodes() {
            const episodes = document.querySelectorAll('[data-episode-id]');
            episodes.forEach(episode => {
                const environment = episode.dataset.environment;
                const algorithm = episode.dataset.algorithm;
                const created = new Date(episode.dataset.created);
                
                // Get episode text for search
                const text = episode.textContent.toLowerCase();
                const searchMatch = !this.searchQuery || text.includes(this.searchQuery.toLowerCase());
                
                // Check algorithm filter
                const algorithmMatch = this.selectedAlgorithms.length === 0 || 
                                     this.selectedAlgorithms.includes(algorithm);
                
                // Check environment filter  
                const environmentMatch = this.selectedEnvironments.length === 0 || 
                                       this.selectedEnvironments.includes(environment);
                
                // Show/hide episode
                const visible = searchMatch && algorithmMatch && environmentMatch;
                episode.style.display = visible ? '' : 'none';
            });
            
            // Apply sorting
            this.sortEpisodes();
        },

        sortEpisodes() {
            const container = document.querySelector('[data-episodes-container]');
            const episodes = Array.from(container.children);
            
            episodes.sort((a, b) => {
                const aEnv = a.dataset.environment;
                const bEnv = b.dataset.environment;
                const aAlgo = a.dataset.algorithm;
                const bAlgo = b.dataset.algorithm; 
                const aCreated = new Date(a.dataset.created);
                const bCreated = new Date(b.dataset.created);
                
                switch(this.sortOrder) {
                    case 'env_asc': return aEnv.localeCompare(bEnv);
                    case 'env_desc': return bEnv.localeCompare(aEnv);
                    case 'algo_asc': return aAlgo.localeCompare(bAlgo);
                    case 'algo_desc': return bAlgo.localeCompare(aAlgo);
                    case 'created_asc': return aCreated - bCreated;
                    case 'created_desc': return bCreated - aCreated;
                    default: return bCreated - aCreated; // newest first
                }
            });
            
            episodes.forEach(episode => container.appendChild(episode));
        }
    }));
});
    </script>
{% endblock %}
{% block content %}
    <div x-cloak
         x-data="episodeManager"
         class="flex flex-col w-full max-w-full overflow-hidden"
         style="height: calc(100vh - 64px)"
         data-insights-url="{% url 'insights' %}">
        <!-- Filter Controls -->
        <div class="flex items-center self-center mx-2 my-3 w-full max-w-full flex-shrink-0">
            {% include "core/partials/episode_filters.html" %}
        </div>
        <!-- Episodes List -->
        <div class="bg-base-200 m-2 p-2 flex-1 overflow-y-auto overflow-x-hidden min-h-0 rounded-sm">
            <ol data-episodes-container class="w-full max-w-full">
                {% for episode in episodes %}
                    {% include "core/partials/episode_card.html" with episode=episode %}
                {% endfor %}
            </ol>
        </div>
        <!-- Action Bar -->
        <div class="w-full max-w-full flex justify-end flex-shrink-0">
            <button x-cloak
                    class="bg-blue-500 hover:bg-blue-800 rounded-lg px-5 py-2.5 me-2 mb-2 disabled:bg-gray-300 disabled:text-gray-400"
                    :disabled="!hasSelectedEpisodes"
                    @click="viewSelectedEpisodes">View All Selected Episodes</button>
        </div>
    </div>
{% endblock %}
