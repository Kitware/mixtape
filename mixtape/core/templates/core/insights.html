{% extends "core/base.html" %}

{% block title %}Inference Results{% endblock %}

{% block content %}

{{ parsed_data|json_script:"parsed_data_json" }}

<div class="insights-container" data-ga-id="insights-page" data-ga-threshold="0.25" data-ga-heartbeat-ms="15000" x-data="(() => {
  const data = JSON.parse(document.getElementById('parsed_data_json').textContent);
  const {
    step_data,
    action_v_reward,
    reward_histogram,
    action_v_frequency,
    unique_agents,
    episode_ids,
    max_steps,
    timeline_key_steps,
    total_rewards,
  } = data;

  const basePlotStyling = (() => {
    return {
      paper_bgcolor: $store.theme.paper_bgcolor,
      plot_bgcolor: $store.theme.plot_bgcolor,
      font: $store.theme.font,
      xaxis: {
        gridcolor: $store.theme.axis.gridcolor,
        zerolinecolor: $store.theme.axis.zerolinecolor
      },
      yaxis: {
        gridcolor: $store.theme.axis.gridcolor,
        zerolinecolor: $store.theme.axis.zerolinecolor
      },
    }
  });

  const legendLayout = () => {
    return {
      orientation: $store.visOptions.legendPosition === 'vertical' ? 'v' : 'h',
      x: $store.visOptions.legendPosition === 'vertical' ? 1 : 0,
      y: ($store.visOptions.legendPosition === 'horizontal' && $store.visOptions.legendOverlap === 'outside') ? -0.1 : 1,
      xanchor: ($store.visOptions.legendOverlap === 'inside' && $store.visOptions.legendPosition === 'vertical') ? 'right' : 'left',
    };
  };

  const basePlotLayout = {
    autosize: true,
    height: 'auto',
    showlegend: $store.visOptions.visible.includes('plotLegends'),
    legend: legendLayout(),
    margin: {l: 40, r: 40, t: 40, b: 40},
    ...basePlotStyling(),
  };

  const basePlotConfig = {
    displayModeBar: false,
    responsive: true
  };

  return {
    parsedData: data,
    actionVReward: action_v_reward,
    rewardHistogram: reward_histogram,
    actionVFrequency: action_v_frequency,
    uniqueAgents: unique_agents,
    episodeIds: episode_ids,
    stepData: step_data,
    timelineKeySteps: timeline_key_steps,
    currentStep: 0,
    playing: false,
    maxSteps: max_steps - 1,
    totalRewards: total_rewards,
    showVisMenu: false,
    showReplayDetails: true,
    basePlotStyling: basePlotStyling,
    basePlotLayout: basePlotLayout,
    basePlotConfig: basePlotConfig,
    legendLayout: legendLayout,
    getStep(step) {
      if (this.currentStep < Object.keys(step).length) {
        return step[Math.max(0, this.currentStep - 1)];
      }
      return step[Object.keys(step).length - 1];
    },
  fps: 1,  // steps per second at 1x playback
    lastFrameTime: 0,
    playbackSpeed: 1.0,  // playback speed multiplier (1x, 1.5x, 2x, 3x, 5x)
    _stepAccumulator: 0,

    setPlaybackSpeed(speed) {
      const v = Number(speed);
      if (!Number.isFinite(v) || v <= 0) return;
      this.playbackSpeed = v;
      // Make the new speed take effect immediately (avoid waiting for old threshold)
      this.lastFrameTime = performance.now();
      this._stepAccumulator = 0;
    },

    stepForward() {
      this.playing = true;
      this.lastFrameTime = performance.now();
      this._stepAccumulator = 0;
      requestAnimationFrame(this.animationLoop.bind(this));
    },

    animationLoop(timestamp) {
      if (!this.playing) return;

      // Time-based accumulation: advances N steps based on elapsed time * fps * playbackSpeed.
      // This makes >1x speeds visible even if the UI/image loading can't render more often.
      const elapsedMs = Math.max(0, timestamp - this.lastFrameTime);
      this.lastFrameTime = timestamp;

      const stepsPerSecond = (this.fps * this.playbackSpeed);
      this._stepAccumulator += (elapsedMs * stepsPerSecond) / 1000;
      const stepsToAdvance = Math.floor(this._stepAccumulator);
      if (stepsToAdvance >= 1) {
        this._stepAccumulator -= stepsToAdvance;
        const nextStep = this.currentStep + stepsToAdvance;
        if (nextStep < this.maxSteps) {
          this.currentStep = nextStep;
        } else {
          this.playing = false;
          this.currentStep = 0;
          return;
        }
      }

      requestAnimationFrame(this.animationLoop.bind(this));
    },
  };
})()"
class="flex"
style="height: calc(100vh - 4rem);"
>
  <!-- Main container with dynamic layout based on denseLayout toggle -->
  <div
    class="flex w-full h-full"
    :class="$store.theme.denseLayout ? 'flex-row' : 'flex-row'"
  >
    <!-- Column A (Episode details) -->
    <div
      id="episode-details-container"
      class="flex flex-col overflow-y-auto overflow-x-hidden transition-all duration-300"
      :class="$store.theme.denseLayout ? 'w-1/3' : 'w-1/3'"
    >
      <template x-for="(step, index) in stepData">
        <div class="episode-container w-full mb-0">
           <div class="flex flex-col w-full min-h-fit p-0 m-0">
             <!-- Removed top step counter header per UX request -->
             
            <div class="flex p-2 min-h-0 col-span-12">
              <div
                x-show="$store.visOptions.visible.includes('episodeImages')"
                class="flex-1 min-h-0 flex items-center justify-center relative py-2"
              >
                <img
                  x-show="getStep(step).image_url"
                  class="m-0 block w-full max-h-[calc(100vh-12rem)] object-contain"
                  :src="getStep(step).image_url"
                  alt="Step Image"
                >
              </div>
            </div>
          </div>
          <div x-show="$store.visOptions.visible.includes('playbackControls')" class="max-w-full p-0 m-0">
            {% include "core/replay_controls.html" %}
          </div>
          <div x-show="$store.visOptions.visible.includes('timelines')" class="max-w-full p-0 m-0">
            {% include "core/timeline.html" %}
          </div>
          <div x-show="$store.visOptions.visible.includes('episodeDetails')" class="w-full mt-2 mr-1">
            <div class="flex items-center justify-between bg-info text-info-content px-4 py-2 rounded-t-md">
              <h3 class="text-sm font-semibold">Step Details</h3>
              <button
                @click="showReplayDetails = !showReplayDetails"
              >
                <i x-show="!showReplayDetails" class="ri-arrow-down-s-line"></i>
                <i x-show="showReplayDetails" class="ri-arrow-up-s-line"></i>
              </button>
            </div>
            <div x-show="showReplayDetails" class="bg-transparent border border-info rounded-b-md border-base-100" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform scale-95" x-transition:enter-end="opacity-100 transform scale-100" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 transform scale-100" x-transition:leave-end="opacity-0 transform scale-95">
              {% include "core/replay_details.html" %}
            </div>
          </div>
        </div>
      </template>
    </div>

    <!-- Plots container - Right side in normal layout, split into columns B and C in dense layout -->
    <div
      id="plots-container"
      class="flex flex-col overflow-y-auto overflow-x-hidden transition-all duration-300"
      :class="$store.theme.denseLayout ? 'w-2/3 flex-row' : 'w-2/3'"
    >
      <!-- When in normal layout, this is a single column -->
      <div
        id="plots-normal-layout"
        class="flex flex-wrap w-full"
        x-show="!$store.theme.denseLayout"
      >
        <div
          id="health-container-B"
          data-ga-id="friendly-health-plot"
          data-ga-threshold="0.5"
          x-show="$store.visOptions.visible.includes('friendlyHealth')"
          class="flex-1 flex-grow min-w-[500px] max-w-full p-1 h-fit"
        >
          {% include "core/friendly_health_over_time.html" %}
        </div>
        <div
          id="decomp-container-B"
          data-ga-id="navigation-reward-plot"
          data-ga-threshold="0.5"
          x-show="$store.visOptions.visible.includes('navigation')"
          class="flex-1 flex-grow min-w-[500px] max-w-full p-1 h-fit"
        >
          {% include "core/navigation_reward_over_time.html" %}
        </div>
        <div
          id="health-container-C"
          x-show="$store.visOptions.visible.includes('enemyHealth')"
          class="flex-1 flex-grow min-w-[500px] max-w-full p-1 h-fit"
        >
          {% include "core/enemy_health_over_time.html" %}
        </div>
        <div
          id="decomp-container-C"
          class="flex-1 flex-grow min-w-[500px] max-w-full p-1 h-fit"
          x-show="$store.visOptions.visible.includes('combatReward')"
        >
          {% include "core/combat_reward_over_time.html" %}
        </div>
        <div
          id="health-death-rewards-container"
          data-ga-id="health-death-rewards-plot"
          data-ga-threshold="0.5"
          x-show="$store.visOptions.visible.includes('healthDeathRewards')"
          class="flex-1 flex-grow min-w-[500px] max-w-full p-1 h-fit"
        >
          {% include "core/health_death_rewards.html" %}
        </div>
        <div
          id="units-container-B"
          x-show="$store.visOptions.visible.includes('unitsOverTime')"
          class="flex-1 flex-grow min-w-[500px] max-w-full p-1 h-fit"
        >
          {% include "core/units_over_time.html" %}
        </div>
        <div
          id="reward-container-C"
          x-show="$store.visOptions.visible.includes('valueEstimate')"
          class="flex-1 flex-grow min-w-[500px] max-w-full p-1 h-fit"
        >
          {% include "core/env_reward_value_estimate.html" %}
        </div>
        <div
          id="units-container-C"
          x-show="$store.visOptions.visible.includes('perUnitActions')"
          class="flex-1 flex-grow min-w-[500px] max-w-full p-1 h-fit"
        >
          {% include "core/per_unit_actions_over_time.html" %}
        </div>
      </div>

      <!-- When in dense layout, split into columns B and C -->
      <div
        id="plots-dense-layout"
        data-ga-id="plots-dense-layout"
        data-ga-threshold="0.3"
        class="flex w-full h-full"
        x-show="$store.theme.denseLayout"
      >
        <!-- Column B (Middle) -->
        <div class="w-1/2 flex flex-col overflow-y-auto overflow-x-hidden">
          <div
            id="health-container-B"
            x-show="$store.visOptions.visible.includes('friendlyHealth')"
            class="w-full p-1 h-fit"
          >
            {% include "core/friendly_health_over_time.html" %}
          </div>
          <div
            id="decomp-container-B"
            x-show="$store.visOptions.visible.includes('navigation')"
            class="w-full p-1 h-fit"
          >
            {% include "core/navigation_reward_over_time.html" %}
          </div>
          <div
            id="health-death-rewards-container-B"
            x-show="$store.visOptions.visible.includes('healthDeathRewards')"
            class="w-full p-1 h-fit"
          >
            {% include "core/health_death_rewards.html" %}
          </div>
          <div
            id="units-container-B"
            x-show="$store.visOptions.visible.includes('unitsOverTime')"
            class="w-full p-1 h-fit"
          >
            {% include "core/units_over_time.html" %}
          </div>
        </div>

        <!-- Column C (Left) -->
        <div class="w-1/2 flex flex-col overflow-y-auto overflow-x-hidden">
          <div
            id="health-container-C"
            x-show="$store.visOptions.visible.includes('enemyHealth')"
            class="w-full p-1 h-fit"
          >
            {% include "core/enemy_health_over_time.html" %}
          </div>
          <div
            id="decomp-container-C"
            class="w-full p-1 h-fit"
            x-show="$store.visOptions.visible.includes('combatReward')"
          >
            {% include "core/combat_reward_over_time.html" %}
          </div>
          <div
            id="reward-container-C"
            x-show="$store.visOptions.visible.includes('valueEstimate')"
            class="w-full p-1 h-fit"
          >
            {% include "core/env_reward_value_estimate.html" %}
          </div>
          <div
            id="units-container-C"
            x-show="$store.visOptions.visible.includes('perUnitActions')"
            class="w-full p-1 h-fit"
          >
            {% include "core/per_unit_actions_over_time.html" %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
