{% extends "core/base.html" %}

{% block title %}Inference Results{% endblock %}

{% block content %}
<div x-data="{
  currentStep: 0,
  plotData: JSON.parse('{{ plot_data_json|escapejs }}')
}">
  <h1 class="text-center text-2xl font-bold">Episode #{{ episode.pk }}</h1>
  <div class="grid grid-cols-12">
    <div class="col-span-3 content-center" x-data="{
        data: [],
        layout: {
          title: {text: 'Actions VS Reward Frequency'},
          xaxis: {title: {text: 'Action'}},
          yaxis: {title: {text: 'Reward Frequency'}},
          autosize: true,
          barmode: 'group',
        },
        plot: null,
      }"
      x-init="
        data = Object.entries(plotData.action_v_reward).reduce((acc, [key, val], idx) => {
          acc.push({ x: Object.keys(val), y: Object.values(val), type: 'bar', name: key });
          return acc;
        }, []);
        plot = Plotly.newPlot($refs.actionsRewards, data, layout)"
    >
      <div x-ref="actionsRewards"></div>
    </div>
    <div class="col-span-3 content-center" x-data="{
        data: [],
        layout: {
          title: {text: 'Rewards VS Frequency'},
          xaxis: {title: {text: 'Reward'}},
          yaxis: {title: {text: 'Frequency'}},
          autosize: true
        },
        plot: null,
      }"
      x-init="
        data = [{x: plotData.reward_histogram, type: 'histogram'}];
        plot = Plotly.newPlot($refs.rewardsFrequency, data, layout)"
    >
      <div x-ref="rewardsFrequency"></div>
    </div>
    <div class="col-span-3 content-center" x-data="{
        data: [],
        layout: {
          title: {text: 'Actions VS Frequency'},
          autosize: true
        },
        plot: null,
      }"
      x-init="
        data = [{labels: Object.keys(plotData.action_v_frequency), values: Object.values(plotData.action_v_frequency), type: 'pie'}];
        plot = Plotly.newPlot($refs.actionsFrequency, data, layout)"
    >
      <div x-ref="actionsFrequency"></div>
    </div>
  </div>
  {% for step in steps %}
  <h1 x-cloak x-show="currentStep === {{ forloop.counter0 }}" class="text-xl font-bold text-center">Step {{ step.number }}</h1>
  <div x-cloak x-show="currentStep === {{ forloop.counter0 }}" class="grid grid-cols-12">
    <div class="col-span-6 content-center m-2">
      <img class="max-h-[45vh]" src="{{ step.image.url }}" alt="Step Image">
    </div>
    <div class="col-span-6 border-gray-300 p-2 max-h-[45vh] overflow-y-scroll">
      {% for agent_step in step.agent_steps.all %}
        <div>
          <p class="flex justify-evenly">
            <span><strong>Agent:</strong> {{ agent_step.agent }}</span>
            <span><strong>Action:</strong> {{ agent_step.action }}</span>
            <span><strong>Reward:</strong> {{ agent_step.reward }}</span>
          </p>
          <p><strong>Observation Space</strong></p>
          <p>
            <pre class="bg-gray-100 p-3 rounded-md font-mono whitespace-pre text-justify text-sm">{{ agent_step.observation_space|pprint }}</pre>
          </p>
          <hr>
        </div>
      {% empty %}
        <p>End of episode</p>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
  <div>
    <input
      type="range"
      id="stepsRange"
      min="0"
      max="{{ steps|length|add:'-1' }}"
      value="0"
      class="w-full"
      x-model.number="currentStep"
    >
  </div>
</div>
{% endblock %}
