<aside x-data="insightsSidePanel()"
       class="bg-[var(--color-surface)] text-[var(--color-surface-foreground)] rounded-lg p-3 w-full lg:w-auto lg:sticky lg:top-4 lg:max-h-[calc(100vh-2rem)] lg:overflow-auto transition-all"
       :class="collapsed ? 'px-1 py-2 w-12 overflow-hidden' : ''">
  <div x-show="!collapsed" x-cloak>
    <div class="flex items-center justify-between mb-2">
      <span class="text-sm font-semibold tracking-wide">MIXTAPE</span>
      <a href="/" class="btn btn-icon btn-accent" title="Home">
        <i class="ri-home-4-line"></i>
      </a>
    </div>
    <hr class="border-[var(--color-border)] mb-2" />
  </div>
  <header class="flex items-center justify-between mb-3"
          x-init="init()">
    <h3 class="text-base font-semibold" x-show="!collapsed">Settings & Tools</h2>
    <div class="flex items-end gap-2">
      <button class="btn btn-icon btn-accent" x-show="!collapsed" x-cloak title="Settings" @click="toggleSettings()" :aria-expanded="settingsOpen">
        <i class="ri-settings-3-line"></i>
      </button>
      <button class="btn btn-icon" :class="collapsed ? 'text-[var(--color-muted-foreground)]' : 'btn-accent'" title="Collapse"
              @click="toggleCollapsed()" :aria-expanded="!collapsed">
        <i class="ri-menu-fold-line" :class="collapsed ? 'rotate-180' : 'rotate-0'"></i>
      </button>
    </div>
  </header>

  <div x-show="!settingsOpen && !collapsed" x-cloak class="space-y-2">
    <section class="card p-3">
      <h3 class="text-sm font-medium mb-2">Selected Episodes</h3>
      <ul class="text-sm space-y-1">
        <template x-if="$store.insights && Array.isArray($store.insights.episodeSummaries) && $store.insights.episodeSummaries.length">
          <template x-for="(ep, idx) in $store.insights.episodeSummaries" :key="idx">
            <li class="flex items-center justify-between">
              <span x-text="'Episode ' + (ep?.id ?? idx)"></span>
            </li>
          </template>
        </template>
      </ul>
    </section>
  </div>

  <div class="space-y-3" x-show="!collapsed" x-cloak>
    <section class="card p-3" x-show="settingsOpen" x-cloak>
      <h3 class="text-sm font-medium mb-2">Playback</h3>
      <div class="flex items-center gap-2">
        <label class="text-sm w-24">Speed</label>
        <input type="number" min="0.1" max="10" step="0.1"
               class="form-input w-15 text-right"
               :value="($store.insights && typeof $store.insights.playbackSpeed === 'number' ? $store.insights.playbackSpeed.toFixed(1) : '1.0')"
               @change="updatePlaybackOnChange($event)"
               @input="updatePlaybackOnInput($event)" />
        <span class="text-sm">x Speed</span>
      </div>
    </section>

    <section class="card p-3" x-show="settingsOpen && $store.insights && Array.isArray($store.insights.episodeSummaries) && $store.insights.episodeSummaries.length > 1" x-cloak>
      <h3 class="text-sm font-medium mb-2">Timeline</h3>
        <div class="flex items-center gap-2 mb-2">
          <label class="flex items-center gap-2 text-sm">
            <input type="radio" name="timeline-mode" class="radio"
                   :checked="$store.insights ? ($store.insights.useGlobalTimeline === true) : true"
                   @change="setGlobalTimeline(true)" />
            Use global timeline
          </label>
        </div>
        <div class="flex items-center gap-2">
          <label class="flex items-center gap-2 text-sm">
            <input type="radio" name="timeline-mode" class="radio"
                   :checked="$store.insights ? ($store.insights.useGlobalTimeline === false) : false"
                   @change="setGlobalTimeline(false)" />
            Use episode timeline
          </label>
          <select class="form-select"
                  :class="(($store.insights && $store.insights.useGlobalTimeline !== false)
                            ? 'opacity-50 cursor-not-allowed bg-[var(--color-muted)]'
                            : '' )"
                  :disabled="(!$store.insights) || ($store.insights.useGlobalTimeline !== false)"
                  :value="$store.insights ? $store.insights.timelineEpisodeIdx : 0"
                  @change="setTimelineEpisodeIdx($event)">
            <template x-for="(ep, idx) in ($store.insights && Array.isArray($store.insights.episodeSummaries) ? $store.insights.episodeSummaries : [])" :key="idx">
              <option :value="idx" x-text="'Episode ' + (ep?.id ?? idx)"></option>
            </template>
          </select>
        </div>
    </section>

    <section class="card p-3" x-show="settingsOpen" x-cloak>
      <h3 class="text-sm font-medium mb-2">Visibility</h3>
      <div class="space-y-3">
        <div>
          <h4 class="text-xs text-[var(--color-muted-foreground)] mb-1">Global</h4>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && Array.isArray($store.insights.visOptions) && $store.insights.visOptions.includes('showPlayback')"
                     @change="$store.insights && $store.insights.toggleVis('showPlayback')" />
              Playback Controls
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && Array.isArray($store.insights.visOptions) && $store.insights.visOptions.includes('showEpisodeInfo')"
                     @change="$store.insights && $store.insights.toggleVis('showEpisodeInfo')" />
              Episode Info
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && Array.isArray($store.insights.visOptions) && $store.insights.visOptions.includes('showMediaViewer')"
                     @change="$store.insights && $store.insights.toggleVis('showMediaViewer')" />
              Media Viewer
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && Array.isArray($store.insights.visOptions) && $store.insights.visOptions.includes('showTimeline')"
                     @change="$store.insights && $store.insights.toggleVis('showTimeline')" />
              Timeline
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('plotLegends')"
                     @change="$store.insights.toggleVis('plotLegends')" />
              Plot Legends
            </label>
          </div>
        </div>
        <div>
          <h4 class="text-xs text-[var(--color-muted-foreground)] mb-1">Overview</h4>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('actionRewardFrequency')"
                     @change="$store.insights.toggleVis('actionRewardFrequency')" />
              Action vs Reward
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('rewardFrequency')"
                     @change="$store.insights.toggleVis('rewardFrequency')" />
              Reward Frequency
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('actionFrequency')"
                     @change="$store.insights.toggleVis('actionFrequency')" />
              Action Frequency
            </label>
          </div>
        </div>
        <div>
          <h4 class="text-xs text-[var(--color-muted-foreground)] mb-1">Rewards</h4>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('rewardsOverTime')"
                     @change="$store.insights.toggleVis('rewardsOverTime')" />
              Rewards Over Time
            </label>
          </div>
        </div>
        <div>
          <h4 class="text-xs text-[var(--color-muted-foreground)] mb-1">Agents</h4>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('obsClustering')"
                     @change="$store.insights.toggleVis('obsClustering')" />
              Observation Clustering
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="checkbox"
                     :checked="$store.insights && $store.insights.get('visOptions')?.includes('actionClustering')"
                     @change="$store.insights.toggleVis('actionClustering')" />
              Action Clustering
            </label>
          </div>
        </div>
      </div>
    </section>
  </div>
</aside>
